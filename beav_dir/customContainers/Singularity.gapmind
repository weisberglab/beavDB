Bootstrap: docker
From: continuumio/miniconda3:23.10.0-1

%labels
    Maintainer "larseamm@oregonstate.edu"
    Description "Container for GapMind + PaperBLAST amino acid synthesis + Diamond"

%files
    gapmind_dbs/aa/curated.db /opt/PaperBLAST/tmp/path.aa/curated.db
    gapmind_dbs/aa/curated.faa /opt/PaperBLAST/tmp/path.aa/curated.faa
    gapmind_dbs/aa/steps.db /opt/PaperBLAST/tmp/path.aa/steps.db
    gapmind_dbs/carbon/curated.db /opt/PaperBLAST/tmp/path.carbon/curated.db
    gapmind_dbs/carbon/curated.faa /opt/PaperBLAST/tmp/path.carbon/curated.faa
    gapmind_dbs/carbon/steps.db /opt/PaperBLAST/tmp/path.carbon/steps.db

%post
    mkdir -p /opt/PaperBLAST/tmp/path.aa /opt/PaperBLAST/tmp/path.carbon
    # Install system dependencies for Perl + build tools + wget for Diamond
    # I've slowly had to add more and more to this each time I test the Gapmind program(it keeps asking for more dependencies)
    apt-get update && apt-get install -y \
        perl \
        libdbi-perl \
        libdbd-sqlite3-perl \
        libwww-perl \
        libxml-libxml-perl \
        libjson-perl \
        libcgi-pm-perl \
        hmmer \
        git \
        g++ \
        make \
        wget \
        && apt-get clean

    # Create conda environment
    conda install -y python=3.9 requests biopython

    # Clone and set up PaperBLAST (includes GapMind data)
    mkdir -p /opt && cd /opt
    git clone https://github.com/morgannprice/PaperBLAST.git
    cd PaperBLAST
    chmod +x bin/extractHmms.pl

    cd /opt/PaperBLAST/tmp/path.aa
    perl /opt/PaperBLAST/bin/extractHmms.pl steps.db .

    cd /opt/PaperBLAST/tmp/path.carbon
    perl /opt/PaperBLAST/bin/extractHmms.pl steps.db .

    # Install Diamond
    DIAMOND_VER="2.0.15"
    wget -q https://github.com/bbuchfink/diamond/releases/download/v${DIAMOND_VER}/diamond-linux64.tar.gz
    tar xzf diamond-linux64.tar.gz
    mv diamond /usr/local/bin/
    chmod +x /usr/local/bin/diamond
    rm diamond-linux64.tar.gz

    # Prebuild diamond databases(amino acid and carbon)
    diamond makedb --in /opt/PaperBLAST/tmp/path.aa/curated.faa \
               -d /opt/PaperBLAST/tmp/path.aa/curated.faa.dmnd
    diamond makedb --in /opt/PaperBLAST/tmp/path.carbon/curated.faa \
               -d /opt/PaperBLAST/tmp/path.carbon/curated.faa.dmnd

%environment
    export PATH="/opt/PaperBLAST/bin:$PATH"
    export PATH="/opt/PaperBLAST:$PATH"
    export PATH="/usr/local/bin:$PATH"

%runscript
    echo "Run GapMind or PaperBLAST from inside this container."
    exec "$@"
